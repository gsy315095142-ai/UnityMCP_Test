# Unity AI 辅助开发插件 - 项目信息

**📌 基于 Unity-MCP 参考项目优化版本**

## 📋 项目概述

### 项目目录
项目本地文件夹地址：C:\Office_Program\UnityTest\UnityMCP_Test

### 核心目标
开发一个基于 **MCP (Model Context Protocol)** 的 Unity 编辑器插件，能够根据用户的自然语言需求描述，自动生成预制体（Prefab）和相关代码，从而加速游戏开发流程。

### 功能定位
在 Unity 编辑器内通过**快捷命令**或**编辑器窗口**输入自然语言需求，调用用户自主配置的 AI 服务（Claude、OpenAI 等），自动生成预制体和代码。可选支持通过 MCP 协议与外部 AI 客户端（Claude Code）集成，提供双重使用方式。

### 与参考项目的差异定位
| 特性 | Unity-MCP (参考) | 我们的项目 |
|------|-----------------|-----------|
| **目标** | 通用 Unity 开发助手 | **专注代码+预制体生成** |
| **复杂度** | 高（60+ Tools，三层架构） | **中（20-30 Tools，简化架构）** |
| **输入方式** | 仅外部（Claude Code等） | **Unity内快捷命令（主）+ MCP Tools（辅）** |
| **AI配置** | 固定（依赖MCP Client） | **用户可自由配置API** ⭐ |
| **适用场景** | 全流程开发 | **快速原型和资源生成** |
| **Runtime 支持** | 是 | **否（初期不做）** |
| **部署方式** | 本地 + 云端 + Docker | **仅本地** |

---

## 🎯 核心功能需求

### 1. 用户交互方式 ⭐⭐⭐ 核心中的核心

#### 主要方式：Unity 内快捷命令（Phase 1 优先）
- [ ] **Quick Command 快捷输入** - 按快捷键（如 `Ctrl+Shift+G`）呼出输入框
  - 轻量级、快速响应
  - 类似 VSCode 命令面板或 Unity Quick Search
  - 输入需求后直接调用 AI 生成
  - ✅ **用户在 Unity 编辑器内输入**

- [ ] **Editor Window 完整窗口**（Phase 2 可选）
  - 提供更完整的配置界面
  - 可查看历史记录
  - 可调整高级参数

#### 辅助方式：MCP Tools（Phase 2-3 可选）
- [ ] 提供 MCP Tools 供外部 AI 客户端调用
- [ ] 用户可在 Claude Code 等工具中使用
- [ ] 作为补充功能，非主要方式

### 2. AI 服务集成 ⭐⭐ 关键功能

#### 用户可自主配置 AI 服务
- [ ] **多 AI 服务商支持**
  - Claude API (Anthropic)
  - OpenAI API (GPT-4o, GPT-4 等)
  - Azure OpenAI
  - 本地模型（Ollama, LM Studio 等）

- [ ] **灵活的配置系统**
  - 用户自己输入 API Key ⭐
  - 可选择不同的模型
  - 可自定义 API Endpoint
  - 支持配置加密存储

- [ ] **配置界面**
  - Settings Window - AI 服务配置窗口
  - 保存多套配置切换使用
  - 测试连接功能

```csharp
// 配置示例
[Serializable]
public class AIServiceConfig
{
    public AIProvider provider;      // Claude / OpenAI / Azure / Local
    public string apiKey;            // 用户输入的 API Key ⭐
    public string modelName;         // 模型选择
    public string customEndpoint;    // 自定义端点
    public float temperature;        // 创造性参数
}
```

### 3. MCP Tools 系统（辅助功能）
- [x] **基于 Attribute 的 Tool 定义** - 参考 Unity-MCP 模式
- [ ] GameObject 操作 Tools（Create, Modify, Find, Destroy）
- [ ] Component 操作 Tools（Add, Modify, Get）
- [ ] Prefab 操作 Tools（Create, Instantiate）
- [ ] Script 生成 Tools（UpdateOrCreate）
- [ ] Scene 管理 Tools（Save, GetData）

### 4. 预制体自动生成
- [ ] 根据需求创建 GameObject 层级结构
- [ ] 自动添加和配置组件（Transform, Renderer, Collider等）
- [ ] 设置组件参数（材质、物理属性等）
- [ ] 支持嵌套预制体引用
- [ ] 资源关联（Sprite, Material, Mesh等）

### 5. 代码自动生成
- [x] **方案确定：初期用模板系统，后期可选 Roslyn**
- [ ] 生成 MonoBehaviour 脚本
- [ ] 生成 ScriptableObject 数据类
- [ ] 生成 Manager/Controller 类
- [ ] 添加必要的命名空间和引用
- [ ] 代码风格遵循项目规范

### 6. 智能上下文理解
- [ ] 通过 MCP Resource 暴露项目资源信息
- [ ] GameObject 层级结构（参考 Unity-MCP 的 Resource 实现）
- [ ] 现有脚本列表
- [ ] 避免命名冲突

### 7. 预览和修改 ⏳ 延后
- [ ] 生成前预览结果（Phase 2）
- [ ] 支持参数调整（Phase 2）
- [ ] 允许用户修改建议（Phase 3）

---

## 🛠️ 技术准备清单（已明确方案）

### Unity相关

#### 1. Unity Editor扩展开发 ✅
- [x] **EditorWindow** - 创建配置窗口（参考 Unity-MCP 的 MainWindowEditor）
- [x] **MenuItem** - 菜单项集成
- [x] **AssetDatabase** - 资源创建和管理
- [x] **PrefabUtility** - 预制体操作 API
- [ ] **SerializedObject/SerializedProperty** - 序列化编辑
- ⏸️ CustomEditor - 暂不需要
- ⏸️ ScriptableWizard - 暂不需要

#### 2. Unity核心系统 ✅
- [x] GameObject 和 Component 系统
- [x] Prefab 系统（基础功能）
- [x] Unity 序列化机制
- [x] Scene 管理
- [ ] Undo/Redo 系统集成（Phase 2）
- ⏸️ AssetBundle - 暂不需要

#### 3. C# 代码生成 ✅ 推荐方案
**初期（Phase 1-2）：字符串模板系统**
```csharp
// 使用简单的字符串模板
string template = @"
namespace {0}
{{
    using UnityEngine;

    public class {1} : MonoBehaviour
    {{
        {2}
    }}
}}";
```

**后期（Phase 3+）：可选 Roslyn**
- [ ] **Roslyn** - 动态编译和执行（参考 Unity-MCP 的 Script.Execute）
- ⏸️ CodeDOM - 不推荐，已过时
- ⏸️ T4 模板 - 过于复杂

### AI 集成 ⭐⭐⭐ 核心中的核心

#### 1. Direct AI 模式 ✅ 主要方案（Phase 1 优先）

**架构：Unity 直接调用 AI API**

```
用户在 Unity 中输入（Quick Command / Editor Window）
    ↓
Unity Plugin 调用 AI Service
    ↓
用户配置的 AI API（Claude / OpenAI / Azure / Local）
    ↓
返回生成结果
    ↓
Unity Plugin 生成代码/预制体
```

**关键特点**：
- ✅ **用户完全自主**：自己选择 AI 服务商，自己配置 API Key
- ✅ **灵活可控**：可以切换不同的 AI 模型和参数
- ✅ **独立运行**：不依赖外部 MCP Client
- ✅ **输入在 Unity 内**：通过快捷键或窗口输入需求

**技术实现**：

```csharp
// AI 服务抽象接口
public interface IAIService
{
    Task<string> GenerateCode(string prompt, ProjectContext context);
    Task<string> GeneratePrefab(string prompt, ProjectContext context);
}

// Claude API 实现
public class ClaudeService : IAIService
{
    private string apiKey;  // 用户配置的 API Key
    private string model = "claude-3-5-sonnet-20241022";

    public async Task<string> GenerateCode(string prompt, ProjectContext context)
    {
        // 构建完整 Prompt
        var fullPrompt = PromptBuilder.Build(prompt, context);

        // 调用 Claude API
        var response = await CallClaudeAPI(fullPrompt);

        return response;
    }
}

// OpenAI API 实现
public class OpenAIService : IAIService { ... }

// AI 服务工厂
public static class AIServiceFactory
{
    public static IAIService Create(AIServiceConfig config)
    {
        return config.provider switch
        {
            AIProvider.Claude => new ClaudeService(config),
            AIProvider.OpenAI => new OpenAIService(config),
            AIProvider.Azure => new AzureOpenAIService(config),
            AIProvider.Local => new LocalLMService(config),
            _ => throw new NotSupportedException()
        };
    }
}
```

**需要实现的组件**：
- [ ] `IAIService` 接口
- [ ] `ClaudeService` - Claude API 实现
- [ ] `OpenAIService` - OpenAI API 实现
- [ ] `AIServiceConfig` - 配置管理（保存 API Key 等）
- [ ] `PromptBuilder` - Prompt 构建器
- [ ] `ResponseParser` - 响应解析器
- [ ] API Key 加密存储

#### 2. MCP Tools 模式 ✅ 辅助方案（Phase 2-3 可选）

**架构：提供 MCP Tools 供外部调用**

```
用户在 Claude Code 中输入
    ↓ MCP Protocol
Unity-MCP-Server（可选使用）
    ↓ SignalR/HTTP
Unity Plugin 的 MCP Tools
    ↓
执行操作
```

**关键特点**：
- ⏸️ **作为补充功能**：不是主要使用方式
- ⏸️ **高级用户可选**：想用 Claude Code 的用户可以使用
- ⏸️ **复用参考项目**：可以直接使用 Unity-MCP-Server

**如果实现 MCP Tools，采用 Attribute 驱动模式**（参考 Unity-MCP）:

```csharp
[McpPluginToolType]
public class Tool_GameObject
{
    [McpPluginTool("gameobject-create", Title = "GameObject / Create")]
    [Description("Create a new GameObject in scene or prefab")]
    public GameObjectRef Create(
        [Description("Name of GameObject")]
        string name,

        [Description("Parent object reference")]
        GameObjectRef? parent = null
    )
    {
        return MainThread.Instance.Run(() =>
        {
            var go = new GameObject(name);
            // ...
            return new GameObjectRef(go);
        });
    }
}
```

#### 3. 核心工具类 ✅ 必须实现（无论哪种模式）
- [ ] **MainThread** - 主线程调度器（参考 Unity-MCP）
- [ ] **GameObjectRef** - GameObject 引用系统
- [ ] **ProjectContext** - 项目上下文信息（用于 AI Prompt）

### 开发环境 ✅ 已确定

#### 1. 必需软件
- [x] **Unity 2022.3.13f1c1** - 目标版本
- [x] **Visual Studio 2022** 或 **JetBrains Rider**
- [x] **Git** - 由用户管理（插件开发仅更新文件，由用户同步到Git）
- [x] **.NET 6.0+** - 用于 AI API 调用（Unity 支持）

#### 2. AI 服务（用户自选，至少一个）
用户需要至少配置一个 AI 服务：
- **Claude API** - 推荐，代码生成能力强
  - 注册：https://console.anthropic.com/
  - 获取 API Key
- **OpenAI API** - GPT-4o, GPT-4 等
  - 注册：https://platform.openai.com/
  - 获取 API Key
- **Azure OpenAI** - 企业用户
- **本地模型** - Ollama, LM Studio（高级用户）

#### 3. 推荐工具
- [x] **Postman** - 测试 AI API 连接
- ⏸️ **Claude Code CLI** - 仅在使用 MCP Tools 模式时需要
- ⏸️ Unity-MCP-Server - 仅在使用 MCP Tools 模式时需要

---

## 📊 需要提供的关键信息

### 1. 项目配置信息 ✅ 已确定

#### Unity 环境
- **目标 Unity 版本**：**2022.3.13f1c1**
- **渲染管线**：**Built-in**（通用性最好，后续可扩展 URP）
- **游戏类型**：**VR 3D**
- **平台目标**：**PC (Windows/Mac/Linux)**

#### 编码规范 ✅ 推荐方案
- **命名约定**：**PascalCase（类、方法、属性）+ camelCase（字段、参数）**
- **代码风格**：**Microsoft C# 规范 + Unity 官方建议**
- **注释要求**：**关键方法使用 XML 文档注释**
- **命名空间策略**：**UnityMCP.{功能模块}**
  ```csharp
  namespace UnityMCP.Tools
  namespace UnityMCP.Generators
  namespace UnityMCP.Core
  ```

### 2. AI 服务配置 ✅ 核心设计

#### 用户可自主配置 AI 服务 ⭐⭐⭐ 关键特性

**配置方式**：通过 Unity 编辑器的 Settings Window 配置

**支持的 AI 服务商**：
- **Claude API** (Anthropic) - 推荐
  - 模型：claude-3-5-sonnet-20241022, claude-3-opus 等
  - 优点：优秀的代码生成和理解能力
  - API Endpoint: https://api.anthropic.com/v1/messages

- **OpenAI API**
  - 模型：gpt-4o, gpt-4, gpt-3.5-turbo 等
  - API Endpoint: https://api.openai.com/v1/chat/completions

- **Azure OpenAI**
  - 企业用户，数据隐私更好
  - 需要配置 Azure Endpoint 和 Deployment Name

- **本地模型**（高级用户）
  - Ollama, LM Studio, LocalAI 等
  - 自定义 Endpoint

**配置参数**：
```csharp
[Serializable]
public class AIServiceConfig
{
    // 基础配置
    public AIProvider provider;        // AI 服务商
    public string apiKey;              // ⭐ 用户输入的 API Key
    public string modelName;           // 模型选择

    // 高级配置
    public string customEndpoint;      // 自定义 API 端点
    public float temperature = 0.7f;   // 创造性 (0-1)
    public int maxTokens = 4000;       // 最大生成长度
    public float topP = 1.0f;          // 采样参数

    // 安全配置
    public bool encryptApiKey = true;  // 加密存储 API Key
    public bool useSystemProxy = false; // 使用系统代理
}
```

**配置界面设计**：
```
Window > AI Assistant > Settings
┌─────────────────────────────────────┐
│ AI Service Settings                 │
├─────────────────────────────────────┤
│ Provider:    [Claude ▼]             │
│                                     │
│ API Key:     [***************]      │
│             [Test Connection]       │
│                                     │
│ Model:       [claude-3-5-sonnet ▼]  │
│                                     │
│ Temperature: [||||----] 0.7         │
│ Max Tokens:  4000                   │
│                                     │
│ [✓] Encrypt API Key                 │
│ [✓] Use System Proxy                │
│                                     │
│ [Save]  [Reset to Default]          │
└─────────────────────────────────────┘
```

**安全措施**：
- ✅ API Key 加密存储（不以明文保存）
- ✅ 不会上传到版本控制（.gitignore）
- ✅ 支持环境变量配置（团队共享配置模板）
- ✅ 连接测试功能（验证 API Key 有效性）

**用户无需 AI 服务的情况**：
- ⏸️ 如果只使用 MCP Tools 模式（通过 Claude Code），则不需要配置 API Key
- ⏸️ MCP Tools 模式下，AI 调用由 Claude Code 处理

### 3. 功能范围定义 ✅ MVP 范围

#### 支持的预制体类型（Phase 1-2）
- [x] **基础 GameObject**（空对象、Cube、Sphere 等基本体）
- [x] **UI 元素**（Button, Panel, Text - UGUI）
- [ ] 游戏对象（角色、道具）- Phase 2
- ⏸️ 特效系统 - Phase 3
- ⏸️ 物理对象 - Phase 2
- ⏸️ 音频系统 - Phase 3

#### 支持的代码类型（Phase 1-2）
- [x] **MonoBehaviour 组件脚本** - Phase 1 核心
- [x] **ScriptableObject 数据类** - Phase 2
- [ ] Manager 单例类 - Phase 2
- ⏸️ 工具类和扩展方法 - Phase 3
- ⏸️ 编辑器扩展脚本 - Phase 3
- ⏸️ Shader - 不做

### 4. 模板和规则库 ✅ 推荐方案

#### 代码模板（初期使用）
```csharp
// MonoBehaviour 模板
public const string MONOBEHAVIOUR_TEMPLATE = @"
namespace {NAMESPACE}
{{
    using UnityEngine;

    /// <summary>
    /// {DESCRIPTION}
    /// </summary>
    public class {CLASS_NAME} : MonoBehaviour
    {{
        #region Fields
        {FIELDS}
        #endregion

        #region Unity Methods
        {UNITY_METHODS}
        #endregion

        #region Public Methods
        {PUBLIC_METHODS}
        #endregion

        #region Private Methods
        {PRIVATE_METHODS}
        #endregion
    }}
}}";

// ScriptableObject 模板
public const string SCRIPTABLEOBJECT_TEMPLATE = @"
namespace {NAMESPACE}
{{
    using UnityEngine;

    [CreateAssetMenu(fileName = ""{FILE_NAME}"", menuName = ""{MENU_PATH}"")]
    public class {CLASS_NAME} : ScriptableObject
    {{
        {FIELDS}
    }}
}}";
```

#### 预制体模板（初期准备）
- **基础 UI 组件**：Button, Panel, InputField 模板
- **3D 基础对象**：带基本组件的预制体模板

### 5. 安全和权限 ✅ 推荐方案

- **允许的操作范围**：
  - ✅ 可创建/修改：`Assets/Scripts/Generated/`, `Assets/Prefabs/Generated/`
  - ✅ 可修改：用户明确指定的现有文件
  - ❌ 禁止操作：`Assets/Plugins/`, 系统核心文件

- **审核机制**：
  - **Phase 1**: 生成后预览，用户确认后创建
  - **Phase 2**: 可选自动执行模式
  - **代码审查**：生成代码在窗口中显示，用户可编辑

---

## 🏗️ 架构设计（混合模式）

### 系统架构 - 主要模式：Direct AI ⭐

```
┌──────────────────────────────────────────────────────────┐
│                      Unity Editor                        │
│                                                          │
│  用户操作：                                               │
│  1. 按快捷键 Ctrl+Shift+G（Quick Command）                 │
│  2. 或打开 Window > AI Assistant                         │
│  3. 输入需求："创建一个Player脚本"                        │
└───────────────────────┬──────────────────────────────────┘
                        │
                        ↓
┌──────────────────────────────────────────────────────────┐
│              Unity AI Plugin（我们开发）                  │
│                                                          │
│  ┌─────────────────────────────────────────────────┐   │
│  │  用户界面层                                      │   │
│  ├─────────────────────────────────────────────────┤   │
│  │  • AIQuickCommand - 快捷输入（Ctrl+Shift+G）     │   │
│  │  • AIAssistantWindow - 完整窗口                  │   │
│  │  • SettingsWindow - AI服务配置窗口 ⭐            │   │
│  │  • PreviewWindow - 生成预览窗口                  │   │
│  └─────────────────────────────────────────────────┘   │
│                        ↓                                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │  AI 服务层 ⭐⭐⭐                                 │   │
│  ├─────────────────────────────────────────────────┤   │
│  │  • IAIService 接口                               │   │
│  │  • ClaudeService - Claude API                   │   │
│  │  • OpenAIService - OpenAI API                   │   │
│  │  • AzureOpenAIService - Azure                   │   │
│  │  • PromptBuilder - Prompt 构建                  │   │
│  │  • ResponseParser - 响应解析                    │   │
│  │  • AIServiceConfig - 配置管理（含API Key）       │   │
│  └─────────────────────────────────────────────────┘   │
│                        ↓                                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │  生成器层                                        │   │
│  ├─────────────────────────────────────────────────┤   │
│  │  • ScriptGenerator - 代码生成（模板系统）        │   │
│  │  • PrefabGenerator - 预制体生成                  │   │
│  │  • ComponentConfigurator - 组件配置              │   │
│  └─────────────────────────────────────────────────┘   │
│                        ↓                                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │  核心工具层                                       │   │
│  ├─────────────────────────────────────────────────┤   │
│  │  • MainThread - 主线程调度                       │   │
│  │  • GameObjectRef - GameObject引用               │   │
│  │  • ProjectContext - 项目上下文                   │   │
│  │  • AssetDatabase API - Unity资源操作            │   │
│  └─────────────────────────────────────────────────┘   │
└───────────────────────┬──────────────────────────────────┘
                        │
                        ↓ HTTP Request
┌──────────────────────────────────────────────────────────┐
│              用户配置的 AI API ⭐                         │
│                                                          │
│  Claude API      │  OpenAI API  │  Azure  │  本地模型   │
│  (用户API Key)   │  (用户API Key) │   ...   │    ...     │
└──────────────────────────────────────────────────────────┘
```

### 辅助架构 - MCP Tools 模式（Phase 2-3可选）⏸️

```
┌─────────────────────────────────────────────────┐
│         Claude Code (MCP Client)                │
│         用户通过对话描述需求                      │
└────────────────┬────────────────────────────────┘
                 │ MCP Protocol (stdio)
                 ↓
┌─────────────────────────────────────────────────┐
│      Unity-MCP-Server (可选使用)                │
└────────────────┬────────────────────────────────┘
                 │ SignalR/HTTP
                 ↓
┌─────────────────────────────────────────────────┐
│      Unity Plugin - MCP Tools 部分              │
│      （与 Direct AI 共用生成器层和核心层）       │
└─────────────────────────────────────────────────┘
```

### 核心模块结构

```
UnityMCP/
├── Editor/
│   ├── UI/                             # 用户界面层 ⭐
│   │   ├── AIQuickCommand.cs           # 快捷输入（Ctrl+Shift+G）
│   │   ├── AIAssistantWindow.cs        # 完整窗口
│   │   ├── SettingsWindow.cs           # AI配置窗口 ⭐⭐
│   │   ├── PreviewWindow.cs            # 生成预览
│   │   └── MenuItems.cs                # 菜单项
│   ├── AI/                             # AI服务层 ⭐⭐⭐ 核心
│   │   ├── IAIService.cs               # AI服务接口
│   │   ├── ClaudeService.cs            # Claude API实现
│   │   ├── OpenAIService.cs            # OpenAI API实现
│   │   ├── AzureOpenAIService.cs       # Azure实现
│   │   ├── LocalLMService.cs           # 本地模型支持
│   │   ├── AIServiceFactory.cs         # 服务工厂
│   │   ├── AIServiceConfig.cs          # 配置管理（含API Key）
│   │   ├── PromptBuilder.cs            # Prompt构建器
│   │   └── ResponseParser.cs           # 响应解析器
│   ├── Generators/                     # 生成器层
│   │   ├── ScriptGenerator.cs          # 代码生成器（模板）
│   │   ├── PrefabGenerator.cs          # 预制体生成器
│   │   └── ComponentConfigurator.cs    # 组件配置器
│   ├── Core/                           # 核心工具层 ⭐
│   │   ├── MainThread.cs               # 主线程调度器
│   │   ├── GameObjectRef.cs            # GameObject引用系统
│   │   ├── ProjectContext.cs           # 项目上下文（用于Prompt）
│   │   └── SecurityValidator.cs        # 安全验证
│   ├── Templates/                      # 模板资源
│   │   ├── MonoBehaviourTemplate.txt   # MonoBehaviour模板
│   │   └── ScriptableObjectTemplate.txt
│   ├── MCP/                            # MCP Tools（可选，Phase 2-3）⏸️
│   │   ├── Tool_GameObject.cs
│   │   ├── Tool_Component.cs
│   │   ├── Tool_Prefab.cs
│   │   └── Tool_Script.cs
│   └── Startup.cs                      # 插件初始化
├── Runtime/                            # (暂不实现)
└── Resources/
    └── Config/
        └── AIServiceConfig.asset       # AI配置资源
```

### 工作流程 - Direct AI 模式

```
┌─────────────────────────────────────────────────────────┐
│ 1. 用户按 Ctrl+Shift+G 或打开 AI Assistant 窗口           │
└─────────────────────┬───────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────┐
│ 2. 输入需求                                              │
│    "创建一个Player脚本，包含移动和跳跃功能"               │
└─────────────────────┬───────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────┐
│ 3. PromptBuilder 构建完整 Prompt                        │
│    - 包含用户需求                                        │
│    - 包含项目上下文（ProjectContext）                    │
│      • Unity版本                                        │
│      • 命名空间规范                                      │
│      • 现有脚本列表                                      │
│      • 代码风格要求                                      │
└─────────────────────┬───────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────┐
│ 4. AIServiceFactory 创建对应的 AI 服务                  │
│    - 读取用户配置（SettingsWindow保存的配置）           │
│    - 根据 provider 创建对应服务（Claude/OpenAI/...）     │
└─────────────────────┬───────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────┐
│ 5. 调用 AI API（HTTP Request）                          │
│    - URL: 用户配置的 API Endpoint                        │
│    - Headers: Authorization: Bearer {用户的API Key}      │
│    - Body: Prompt + Model 参数                          │
└─────────────────────┬───────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────┐
│ 6. AI 返回生成结果（JSON格式）                           │
│    {                                                    │
│      "scriptName": "Player",                            │
│      "namespace": "Game.Player",                        │
│      "code": "...",                                     │
│      "fields": [...],                                   │
│      "methods": [...]                                   │
│    }                                                    │
└─────────────────────┬───────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────┐
│ 7. ResponseParser 解析 AI 响应                          │
│    - 验证 JSON 格式                                      │
│    - 提取代码内容                                        │
└─────────────────────┬───────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────┐
│ 8. ScriptGenerator 生成代码                             │
│    - 使用模板系统填充内容                                │
│    - 格式化代码                                          │
│    - 验证命名冲突                                        │
└─────────────────────┬───────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────┐
│ 9. PreviewWindow 显示生成的代码                          │
│    - 用户可以编辑                                        │
│    - 用户可以取消                                        │
└─────────────────────┬───────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────┐
│ 10. 用户确认后，MainThread 切换到主线程                  │
│     - AssetDatabase.CreateAsset(...)                   │
│     - 写入文件到 Assets/Scripts/Generated/Player.cs     │
│     - AssetDatabase.Refresh()                          │
└─────────────────────┬───────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────┐
│ 11. Unity 自动编译新脚本                                 │
│     ✅ 完成！用户可以在项目中使用 Player.cs              │
└─────────────────────────────────────────────────────────┘
```

---

## 🚀 开发路线图（基于参考项目调整）

### Phase 1: 核心框架 + MVP（3-4周）⭐

**目标：实现最小可用版本**

#### Week 1-2: 基础架构
- [ ] **搭建项目结构**
  - 创建 Unity 项目（2022.3.13f1c1）
  - 设置 Assembly Definition
  - 注：Git 由用户管理

- [ ] **核心工具类实现**
  - `MainThread.cs` - 主线程调度器
  - `GameObjectRef.cs` - GameObject 引用系统
  - Attribute 定义（`McpPluginToolType`, `McpPluginTool`）

- [ ] **集成 Unity-MCP-Server**
  - 下载/引用 Unity-MCP-Server
  - 配置 SignalR 连接
  - 测试连接成功

#### Week 3-4: 核心 Tools 实现
- [ ] **Tool_Script.cs** - 最重要
  - `UpdateOrCreate()` - 创建/更新脚本
  - `ScriptGenerator.cs` - 基于模板生成代码
  - MonoBehaviour 模板

- [ ] **Tool_GameObject.cs**
  - `Create()` - 创建 GameObject
  - `Modify()` - 修改属性

- [ ] **Tool_Prefab.cs**
  - `Create()` - 创建预制体

- [ ] **配置窗口**
  - 基础的 EditorWindow
  - MCP Server 连接状态显示
  - 一键配置 Claude Code

**Phase 1 里程碑**：
用户可以在 Claude Code 中说 "创建一个 Player 脚本"，插件自动生成代码文件。

---

### Phase 2: 完善核心功能（4-5周）

#### Week 5-6: 扩展 Tools
- [ ] **Tool_Component.cs**
  - `Add()` - 添加组件
  - `Modify()` - 修改组件属性

- [ ] **Tool_Scene.cs**
  - `Save()` - 保存场景
  - `GetData()` - 获取场景信息

- [ ] **ScriptableObject 支持**
  - ScriptableObject 模板
  - `Tool_Script` 扩展

#### Week 7-8: 上下文和优化
- [ ] **MCP Resource 实现**
  - `Resource_SceneHierarchy` - 场景层级信息
  - 暴露给 AI，帮助理解项目结构

- [ ] **代码质量提升**
  - 错误处理和详细反馈
  - 命名冲突检测
  - 代码格式化

#### Week 9: 测试和文档
- [ ] 端到端测试
- [ ] 用户文档
- [ ] 示例场景

**Phase 2 里程碑**：
用户可以生成完整的游戏对象（GameObject + Components + Scripts），并保存为预制体。

---

### Phase 3: 智能优化（3-4周）⏳ 可选

- [ ] **Roslyn 集成**（参考 Unity-MCP 的 Script.Execute）
  - 动态编译和验证
  - 即时代码执行

- [ ] **智能推荐**
  - 分析项目现有代码风格
  - 推荐常用组件组合

- [ ] **预览系统**
  - 生成前预览
  - 参数调整界面

---

### Phase 4: 完善和发布（2-3周）⏳

- [ ] 性能优化
- [ ] 单元测试
- [ ] 完整文档
- [ ] 示例项目
- [ ] 发布准备

---

## ⚠️ 技术难点和解决方案

### 1. AI 输出的可靠性 ✅ 已有方案
- **参考项目方案**：
  - 使用 `Description` Attribute 详细描述每个参数
  - 返回详细的错误信息，帮助 AI 自我纠正
  - 结构化的返回类型（GameObjectRef, SerializedMember）

### 2. 主线程调度 ✅ 已有方案
- **参考项目方案**：
  ```csharp
  public class MainThread : MonoBehaviour
  {
      public T Run<T>(Func<T> action)
      {
          // 使用 TaskCompletionSource 在主线程执行
      }
  }
  ```
  - 所有 Unity API 调用必须包装在 `MainThread.Run()`

### 3. GameObject 引用 ✅ 已有方案
- **参考项目方案**：
  ```csharp
  public class GameObjectRef
  {
      public string scenePath;
      public string hierarchyPath;
      public int instanceId;

      public GameObject FindGameObject(out string error)
      {
          // 通过多种方式定位对象
      }
  }
  ```

### 4. 代码生成质量 ✅ 推荐方案
**Phase 1-2：模板 + 验证**
- 使用预定义模板
- 生成后显示给用户确认
- 检查命名冲突

**Phase 3：Roslyn 验证**
- 编译检查语法错误
- 返回详细错误信息

### 5. AI API 调用 ✅ Direct AI 模式关键
- **HTTP 客户端实现**：
  - 使用 UnityWebRequest 或 HttpClient
  - 异步调用（async/await）
  - 错误处理和重试

- **API Key 管理**：
  - 加密存储在 EditorPrefs 或配置文件
  - 不提交到版本控制
  - 支持环境变量

---

## 📊 MVP 功能清单（已更新为 Direct AI 模式）

### Phase 1 必须实现（3-4周）

| 功能 | 优先级 | 预计工作量 | 状态 |
|------|-------|-----------|------|
| **AI服务层** | | | |
| IAIService 接口 | P0 | 1天 | ⬜ 待开始 |
| ClaudeService 实现 | P0 | 3天 | ⬜ 待开始 |
| AIServiceConfig 配置管理 | P0 | 2天 | ⬜ 待开始 |
| PromptBuilder 构建器 | P0 | 2天 | ⬜ 待开始 |
| ResponseParser 解析器 | P0 | 2天 | ⬜ 待开始 |
| **UI层** | | | |
| AIQuickCommand 快捷输入 | P0 | 2天 | ⬜ 待开始 |
| SettingsWindow AI配置窗口 | P0 | 3天 | ⬜ 待开始 |
| PreviewWindow 预览窗口 | P1 | 2天 | ⬜ 待开始 |
| **核心层** | | | |
| MainThread 调度器 | P0 | 2天 | ⬜ 待开始 |
| GameObjectRef 引用系统 | P0 | 2天 | ⬜ 待开始 |
| ProjectContext 上下文 | P0 | 2天 | ⬜ 待开始 |
| **生成器层** | | | |
| ScriptGenerator（模板） | P0 | 3天 | ⬜ 待开始 |
| MonoBehaviour 模板 | P0 | 1天 | ⬜ 待开始 |
| **安全和测试** | | | |
| API Key 加密存储 | P0 | 1天 | ⬜ 待开始 |
| 端到端测试 | P1 | 2天 | ⬜ 待开始 |
| 用户文档 | P1 | 2天 | ⬜ 待开始 |

**总计：约 32 天（4.5 周）**

### Phase 2 重要功能（4-5周）

- OpenAIService 实现（支持多 AI）
- PrefabGenerator 预制体生成
- AIAssistantWindow 完整窗口
- ScriptableObject 模板
- Component 配置系统
- 错误处理优化

### Phase 3 可选功能（按需）⏸️

- MCP Tools 模式支持
- Roslyn 动态编译
- 本地模型支持
- 高级 Prompt 优化
- 代码质量分析

---

## 📚 学习资源（已更新）

### 必读
1. **Unity-MCP 源码**
   - `Tool_GameObject.Create.cs` - Tool 定义示例
   - `Script.Execute.cs` - Roslyn 使用示例
   - `MainThread.cs` - 主线程调度
   - `GameObjectRef.cs` - 对象引用

2. **MCP 协议文档**
   - https://modelcontextprotocol.io/
   - Tool/Resource/Prompt 概念

3. **Unity Editor 扩展**
   - Unity 官方文档：EditorWindow, AssetDatabase
   - SignalR .NET Client 文档

### 参考项目
- Unity-MCP: https://github.com/IvanMurzak/Unity-MCP
- MCP Protocol: https://modelcontextprotocol.io/

---

## 📝 下一步行动（已明确）

### 立即开始（本周）

1. **环境搭建** ✅
   - [x] 确定技术栈（已完成）
   - [ ] 创建 Unity 2022.3 LTS 项目
   - [ ] 注册 AI 服务并获取 API Key
     - Claude API: https://console.anthropic.com/
     - 或 OpenAI API: https://platform.openai.com/
   - ⏸️ 安装 Claude Code CLI（仅使用 MCP Tools 模式时需要）

2. **学习参考项目**（重点不同）
   - [ ] 阅读 Unity-MCP 核心工具类（2-3小时）
     - MainThread.cs - 主线程调度
     - GameObjectRef.cs - 对象引用
   - [ ] 了解 Claude/OpenAI API（1-2小时）
     - 阅读 API 文档
     - 测试 API 调用（Postman）
   - ⏸️ 理解 MCP 协议（可选，Phase 2-3 需要）

3. **开始 Phase 1 开发**
   - [ ] 实现核心工具类
     - MainThread 调度器
     - GameObjectRef 引用系统
     - ProjectContext 上下文
   - [ ] 实现 AI 服务层
     - IAIService 接口
     - ClaudeService 实现
     - AIServiceConfig 配置
   - [ ] 实现基础 UI
     - SettingsWindow（配置 API Key）
     - AIQuickCommand（快捷输入）

### 本月目标

完成 Phase 1 MVP：用户可以在 Unity 中按快捷键，输入需求，自动调用 AI 生成代码。

---

## 💡 关键决策记录

| 决策项 | 选择方案 | 理由 | 日期 |
|--------|---------|------|------|
| **架构模式** ⭐ | **Direct AI（主）+ MCP Tools（辅）** | 用户在Unity内使用，更独立灵活 | 2026-02-01 |
| **AI API配置** ⭐ | **用户可自主配置API Key** | 支持多AI服务商，用户自由选择 | 2026-02-01 |
| **输入方式** ⭐ | **Quick Command（主）+ Editor Window（辅）** | 快捷、轻量、高效 | 2026-02-01 |
| **代码生成** | Phase 1-2 用模板，Phase 3 可选 Roslyn | 降低初期复杂度，保留扩展性 | 2026-02-01 |
| **Unity 版本** | 2022.3 LTS | 稳定可靠，广泛使用 | 2026-02-01 |
| **支持的AI** | Claude（优先）+ OpenAI + Azure + 本地 | 灵活选择，不绑定单一服务商 | 2026-02-01 |
| **MCP Tools** | Phase 2-3 可选实现 | 作为补充功能，非主要方式 | 2026-02-01 |
| **Runtime 支持** | 暂不实现 | 专注编辑器功能，降低复杂度 | 2026-02-01 |

---

## 📞 项目信息

- **项目路径**：C:\Office_Program\UnityTest\UnityMCP_Test
- **参考项目**：C:\OfficeTool\unity_MCP\Unity-MCP-main
- **文档更新日期**：2026-02-01（架构重大更新）
- **当前阶段**：✅ 技术方案确定（Direct AI 模式），准备开始开发
- **预计 MVP 完成**：4-5 周后

---

## ✅ 待确认信息（需要用户决定）

以下信息需要根据实际情况确认：

1. **项目命名空间**
   - 推荐：`UnityMCP.{模块名}`
   - 或自定义：`YourProject.{模块名}`

2. **生成脚本的默认路径**
   - 推荐：`Assets/Scripts/Generated/`
   - 或自定义路径

3. **生成预制体的默认路径**
   - 推荐：`Assets/Prefabs/Generated/`
   - 或自定义路径

4. **是否需要特定的代码风格**
   - 推荐：Microsoft C# + Unity 官方
   - 或公司/团队特定规范

5. **是否有特定的 Unity 包依赖**
   - 如：TextMeshPro, Cinemachine, Input System 等
   - 需要在代码模板中考虑

---

**📌 重要提醒**：
1. 本项目定位是"专注代码和预制体生成"，不是全功能开发助手
2. 优先保证核心功能质量，而非功能数量
3. 参考 Unity-MCP 的成熟工具类（MainThread、GameObjectRef），但**不依赖其 MCP 架构**
4. MVP 完成后，根据实际使用反馈决定后续方向

---

## 🔄 架构变更说明（2026-02-01）

### 重大决策调整

**之前的方案**：
- ❌ 依赖 Unity-MCP-Server 作为中间层
- ❌ 依赖 Claude Code 作为唯一输入方式
- ❌ 用户无法自主选择 AI 服务
- ❌ 不需要 API Key（由 Claude Code 提供）

**现在的方案** ⭐：
- ✅ Unity 插件直接调用 AI API（Direct AI 模式）
- ✅ 用户在 Unity 内输入需求（Quick Command / Editor Window）
- ✅ **用户可自主配置 AI 服务和 API Key**
- ✅ 支持多个 AI 服务商（Claude / OpenAI / Azure / 本地模型）
- ✅ MCP Tools 作为可选的辅助功能（Phase 2-3）

### 为什么改变？

1. **用户更自由**：可以选择自己喜欢的 AI 服务和模型
2. **更独立**：不依赖外部 MCP Client，完全在 Unity 内使用
3. **更灵活**：可以切换不同的 API Key，控制成本
4. **更直观**：在 Unity 中按快捷键输入，比切换到 Claude Code 更方便

### 关键优势

| 方面 | Direct AI 模式 | MCP Tools 模式 |
|------|---------------|----------------|
| **输入位置** | Unity 编辑器内 | Claude Code 等外部工具 |
| **API配置** | 用户自主配置 | 依赖 MCP Client |
| **灵活性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **独立性** | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| **实现复杂度** | 中等 | 较低 |
| **用户体验** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

### 下一步

按照新的架构开始 Phase 1 开发，重点实现：
1. AI 服务层（IAIService、ClaudeService、配置管理）
2. 快捷输入界面（AIQuickCommand）
3. AI 配置窗口（SettingsWindow）
4. 代码生成器（ScriptGenerator）

---

**文档最后更新**: 2026-02-01 - 架构重大调整，改为 Direct AI 主导模式
